<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VoiceGuard - Live Protection Dashboard</title>
    <meta name="description" content="VoiceGuard's live dashboard for managing safety features like voice recording, trusted contacts, and evidence uploading." />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Embedded CSS -->
    <style>
        /* CSS Variables */
        :root {
            --bg: #0b0b0d;
            --fg: #f2f2f2;
            --accent: #e21d2f;
            --muted: #8a8a8a;
            --border: rgba(242, 242, 242, 0.1);
            --card-bg: rgba(255, 255, 255, 0.02);
            --shadow: 0 4px 20px rgba(226, 29, 47, 0.3);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Calm Mode Variables */
        [data-mode="calm"] {
            --bg: #101217;
            --fg: #eef2f7;
            --accent: #7c3aed;
            --muted: #9aa5b1;
            --border: rgba(238, 242, 247, 0.1);
            --card-bg: rgba(255, 255, 255, 0.03);
            --shadow: 0 4px 20px rgba(124, 58, 237, 0.2);
        }

        /* Base Styles */
        body {
            background-color: var(--bg);
            color: var(--fg);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            transition: var(--transition);
        }

        /* Header */
        header {
            background: rgba(11, 11, 13, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            z-index: 1000;
        }

        [data-mode="calm"] header {
            background: rgba(16, 18, 23, 0.95);
        }

        .navbar {
            padding: 1rem 0;
        }

        .logo-svg {
            height: 40px;
            width: 200px;
        }

        .logo-text {
            font-size: 24px;
            font-weight: bold;
            letter-spacing: -0.5px;
        }

        .nav-btn, .nav-select {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--fg);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
        }

        .nav-btn:hover, .nav-select:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .nav-select option {
            background: var(--bg);
            color: var(--fg);
        }

        .exit-btn {
            background: var(--accent) !important;
            color: white !important;
            border-color: var(--accent) !important;
        }

        /* Main Content */
        main {
            padding: 80px 0;
        }

        .section-title {
            font-size: 2.5rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 1rem;
        }

        .empowering-quote {
            text-align: center;
            color: var(--muted);
            font-style: italic;
            margin-bottom: 4rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .feature-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            transition: var(--transition);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
            box-shadow: var(--shadow);
        }

        .feature-card h3 {
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--accent);
        }

        .feature-card p {
            color: var(--muted);
            flex-grow: 1;
        }

        /* Voice Recorder */
        .recorder-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 1rem;
            font-weight: bold;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--muted);
            transition: var(--transition);
        }

        .status-dot.recording {
            background-color: var(--accent);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(226, 29, 47, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(226, 29, 47, 0); }
            100% { box-shadow: 0 0 0 0 rgba(226, 29, 47, 0); }
        }

        [data-mode="calm"] .status-dot.recording {
            animation-name: pulse-calm;
        }

        @keyframes pulse-calm {
            0% { box-shadow: 0 0 0 0 rgba(124, 58, 237, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(124, 58, 237, 0); }
            100% { box-shadow: 0 0 0 0 rgba(124, 58, 237, 0); }
        }

        /* Trusted Contacts */
        .contact-list {
            list-style: none;
            padding: 0;
            margin-top: 1rem;
        }

        .contact-item {
            background: rgba(0,0,0,0.2);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .remove-contact-btn {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
        }
        .remove-contact-btn:hover {
            color: var(--accent);
        }

        /* Evidence Locker */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        .upload-area:hover {
            border-color: var(--accent);
            background-color: rgba(255,255,255,0.05);
        }
        .file-list {
            list-style: none;
            padding: 0;
            margin-top: 1rem;
            text-align: left;
        }
        .file-item {
            background: rgba(0,0,0,0.2);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }
        .remove-file-btn {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
        }
        .remove-file-btn:hover {
            color: var(--accent);
        }

        /* General Form & Button Styles */
        .form-control {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            color: var(--fg);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            transition: var(--transition);
        }

        .form-control:focus {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--accent);
            box-shadow: 0 0 0 0.2rem rgba(226, 29, 47, 0.25);
            color: var(--fg);
        }

        .btn-primary {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            transition: var(--transition);
        }

        .btn-primary:hover {
            filter: brightness(1.2);
            transform: translateY(-2px);
        }

        /* Footer */
        .site-footer {
            background: rgba(0, 0, 0, 0.8);
            border-top: 1px solid var(--border);
            padding: 3rem 0 2rem;
            margin-top: 4rem;
        }

        /* Chatbot Styles */
        .chatbot {
            position: fixed;
            bottom: 25px;
            right: 25px;
            z-index: 1050;
        }

        .chatbot-icon {
            width: 60px;
            height: 60px;
            background-color: var(--accent);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease-in-out;
        }

        .chatbot-icon:hover {
            transform: scale(1.1);
        }

        .chatbot-icon svg {
            width: 32px;
            height: 32px;
        }

        .chatbot-window {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 350px;
            max-width: 90vw;
            background-color: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px);
            visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
        }

        .chatbot-window.open {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }

        .chatbot-header {
            background-color: var(--accent);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chatbot-title {
            font-weight: bold;
        }

        .chatbot-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            line-height: 1;
            cursor: pointer;
            opacity: 0.8;
            padding: 0;
        }

        .chatbot-close:hover {
            opacity: 1;
        }

        .chatbot-body {
            padding: 1rem;
            height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .chatbot-message {
            padding: 0.5rem 1rem;
            border-radius: 18px;
            margin-bottom: 0.5rem;
            max-width: 80%;
            line-height: 1.4;
            font-size: 0.9rem;
        }

        .chatbot-message.bot {
            background-color: rgba(255, 255, 255, 0.05);
            border-bottom-left-radius: 4px;
            align-self: flex-start;
        }
        
        .chatbot-message.user {
            background-color: var(--accent);
            color: white;
            border-bottom-right-radius: 4px;
            align-self: flex-end;
        }

        .chatbot-footer {
            display: flex;
            padding: 0.5rem;
            border-top: 1px solid var(--border);
            background-color: rgba(0,0,0,0.2);
        }

        #chatbot-input {
            flex-grow: 1;
            border: none;
            background: transparent;
            color: var(--fg);
            padding: 0.5rem;
        }

        #chatbot-input:focus {
            outline: none;
        }

        #chatbot-send {
            background: var(--accent);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #chatbot-send:hover {
            filter: brightness(1.2);
        }

        /* Simple toast notification for feedback */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--accent);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
            visibility: hidden;
            pointer-events: none;
        }
        .toast-notification.show {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="sticky-top">
        <nav class="navbar navbar-expand-lg" role="navigation">
            <div class="container">
                <!-- Logo -->
                <a class="navbar-brand" href="/" aria-label="VoiceGuard Home">
                    <svg class="logo-svg" viewBox="0 0 200 40" aria-hidden="true">
                        <defs>
                            <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:var(--accent);stop-opacity:1" />
                                <stop offset="100%" style="stop-color:var(--fg);stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <text x="10" y="28" class="logo-text" fill="url(#logoGrad)">VoiceGuard</text>
                    </svg>
                </a>

                <!-- Controls -->
                <div class="navbar-nav ms-auto d-flex flex-row gap-3">
                    <button id="mode-toggle" class="nav-btn" aria-label="Toggle between Impact and Calm mode">
                        <span id="mode-text">Calm</span>
                    </button>
                    <select id="language-select" class="nav-select" aria-label="Select language">
                        <option value="en">EN</option>
                        <option value="hi">हिं</option>
                        <option value="bn">বাংলা</option>
                        <option value="ta">தமிழ்</option>
                        <option value="te">తెలుగు</option>
                        <option value="mr">मराठी</option>
                    </select>
                    <button id="header-exit" class="nav-btn exit-btn" aria-label="Quick Exit" data-i18n="exit_button">Exit</button>
                </div>
            </div>
        </nav>
    </header>

    <main id="main-content">
        <div class="container">
            <h1 class="section-title" data-i18n="page_title">Protection Dashboard</h1>
            <p class="empowering-quote" data-i18n="page_quote">"The most courageous act is still to think for yourself. Aloud." - Coco Chanel</p>

            <div class="row g-4">
                <!-- Voice Recorder -->
                <div class="col-lg-4 col-md-6">
                    <div class="feature-card">
                        <h3 data-i18n="recorder_title">Voice Recorder</h3>
                        <p data-i18n="recorder_desc">Silently record background audio. The recording will be encrypted and stored securely.</p>
                        <button id="record-btn" class="btn btn-primary w-100" data-i18n="recorder_start">Start Recording</button>
                        <div class="recorder-status">
                            <div id="status-dot" class="status-dot"></div>
                            <span id="status-text" data-i18n="recorder_idle">Idle</span>
                        </div>
                    </div>
                </div>

                <!-- Trusted Contacts -->
                <div class="col-lg-4 col-md-6">
                    <div class="feature-card">
                        <h3 data-i18n="contacts_title">Trusted Contacts</h3>
                        <p data-i18n="contacts_desc">Add phone numbers of people you trust. In an emergency, an alert can be sent to them.</p>
                        <div class="input-group">
                            <input type="tel" id="contact-input" class="form-control" placeholder="Enter phone number" data-i18n-placeholder="contacts_placeholder">
                            <button id="add-contact-btn" class="btn btn-primary" data-i18n="contacts_add">Send SOS</button>
                        </div>
                        <ul id="contact-list" class="contact-list"></ul>
                    </div>
                </div>

                <!-- Evidence Locker -->
                <div class="col-lg-4 col-md-12">
                    <div class="feature-card">
                        <h3 data-i18n="evidence_title">Evidence Locker</h3>
                        <p data-i18n="evidence_desc">Securely upload photos, screenshots, or documents. Your evidence is encrypted and private.</p>
                        <div id="upload-area" class="upload-area">
                            <span data-i18n="evidence_upload_prompt">Click or drag files here</span>
                        </div>
                        <input type="file" id="file-input" multiple hidden>
                        <ul id="file-list" class="file-list"></ul>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="site-footer">
        <div class="container text-center">
            <p class="text-muted" data-i18n="footer_disclaimer">For your safety, all data is encrypted. Remember to use the Exit button if you need to leave quickly.</p>
        </div>
    </footer>

    <!-- Asha Chatbot -->
    <div id="asha-chatbot" class="chatbot">
        <div class="chatbot-window" id="chatbot-window">
            <div class="chatbot-header">
                <span class="chatbot-title" data-i18n="chatbot_title">Asha</span>
                <button class="chatbot-close" id="chatbot-close" aria-label="Close chat">&times;</button>
            </div>
            <div class="chatbot-body" id="chatbot-body">
                <div class="chatbot-message bot" data-i18n="chatbot_greeting">Hello! I'm Asha, your support assistant. How can I help you today?</div>
            </div>
            <div class="chatbot-footer">
                <input type="text" id="chatbot-input" data-i18n-placeholder="chatbot_placeholder" placeholder="Type a message...">
                <button id="chatbot-send" aria-label="Send message">
                    <svg fill="white" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
                        <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="chatbot-icon" id="chatbot-icon" role="button" aria-label="Open support chat">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">
                <path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18zM18 14H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
            </svg>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast-notification" class="toast-notification"></div>


    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Embedded JavaScript -->
    <script>
        // --- !! CRITICAL SAFETY FEATURE !! ---
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                document.body.innerHTML = '';
                window.location.replace('https://weather.com');
            }
        });

        class VoiceGuardDemoApp {
            constructor() {
                this.currentMode = localStorage.getItem('voiceguard-mode') || 'impact';
                this.currentLang = localStorage.getItem('voiceguard-lang') || 'en';
                this.isRecording = false;
                this.trustedContacts = []; // This will now just be for display
                this.uploadedFiles = [];
                // --- Chatbot User ID ---
                this.chatbotUserId = this.getChatbotUserId();

                this.initializeApp();
                this.setupEventListeners();
            }

            // --- I18N (Internationalization) ---
            i18n = {
                en: {
                    exit_button: "Exit",
                    page_title: "Protection Dashboard",
                    page_quote: "\"The most courageous act is still to think for yourself. Aloud.\" - Coco Chanel",
                    recorder_title: "Voice Recorder",
                    recorder_desc: "Silently record background audio. The recording will be encrypted and stored securely.",
                    recorder_start: "Start Recording",
                    recorder_stop: "Stop Recording",
                    recorder_idle: "Idle",
                    recorder_recording: "Recording...",
                    contacts_title: "Trusted Contacts",
                    contacts_desc: "Add phone numbers of people you trust. In an emergency, an alert can be sent to them.",
                    contacts_placeholder: "Enter phone number",
                    contacts_add: "Send SOS",
                    evidence_title: "Evidence Locker",
                    evidence_desc: "Securely upload photos, screenshots, or documents. Your evidence is encrypted and private.",
                    evidence_upload_prompt: "Click or drag files here",
                    footer_disclaimer: "For your safety, all data is encrypted. Remember to use the Exit button if you need to leave quickly.",
                    chatbot_title: "Asha",
                    chatbot_greeting: "Hello! I'm Asha, your support assistant. How can I help you today?",
                    chatbot_placeholder: "Type a message..."
                },
                hi: {
                    exit_button: "बाहर निकलें",
                    page_title: "सुरक्षा डैशबोर्ड",
                    page_quote: "\"सबसे साहसी कार्य अभी भी अपने लिए सोचना है। ज़ोर से।\" - कोको शनैल",
                    recorder_title: "वॉयस रिकॉर्डर",
                    recorder_desc: "चुपचाप पृष्ठभूमि ऑडियो रिकॉर्ड करें। रिकॉर्डिंग एन्क्रिप्ट की जाएगी और सुरक्षित रूप से संग्रहीत की जाएगी।",
                    recorder_start: "रिकॉर्डिंग शुरू करें",
                    recorder_stop: "रिकॉर्डिंग बंद करें",
                    recorder_idle: "निष्क्रिय",
                    recorder_recording: "रिकॉर्डिंग हो रही है...",
                    contacts_title: "विश्वसनीय संपर्क",
                    contacts_desc: "जिन लोगों पर आप भरोसा करते हैं उनके फ़ोन नंबर जोड़ें। आपात स्थिति में, उन्हें एक अलर्ट भेजा जा सकता है।",
                    contacts_placeholder: "फ़ोन नंबर दर्ज करें",
                    contacts_add: "SOS भेजें",
                    evidence_title: "सबूत लॉकर",
                    evidence_desc: "फ़ोटो, स्क्रीनशॉट या दस्तावेज़ सुरक्षित रूप से अपलोड करें। आपके सबूत एन्क्रिप्टेड और निजी हैं।",
                    evidence_upload_prompt: "फ़ाइलों को यहां क्लिक करें या खींचें",
                    footer_disclaimer: "आपकी सुरक्षा के लिए, सभी डेटा एन्क्रिप्ट किया गया है। यदि आपको जल्दी से बाहर निकलने की आवश्यकता है तो बाहर निकलें बटन का उपयोग करना याद रखें।",
                    chatbot_title: "आशा",
                    chatbot_greeting: "नमस्ते! मैं आशा हूँ, आपकी सहायक। मैं आज आपकी कैसे मदद कर सकती हूँ?",
                    chatbot_placeholder: "संदेश लिखें..."
                },
                // ... other languages ...
            };

            // --- INITIALIZATION ---
            initializeApp() {
                document.documentElement.setAttribute('data-mode', this.currentMode);
                this.updateModeToggle();
                this.updateLanguage();
                this.renderContacts();
                this.loadChatHistory();
            }

            // --- EVENT LISTENERS ---
            setupEventListeners() {
                document.getElementById('mode-toggle').addEventListener('click', () => this.toggleMode());
                document.getElementById('language-select').addEventListener('change', (e) => this.setLanguage(e.target.value));
                document.getElementById('header-exit').addEventListener('click', () => this.quickExit());
                document.addEventListener('keydown', (e) => { if (e.key === 'Escape') this.quickExit(); });

                document.getElementById('record-btn').addEventListener('click', () => this.toggleRecording());
                document.getElementById('add-contact-btn').addEventListener('click', () => this.sendSOS());
                document.getElementById('contact-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') this.sendSOS(); });
                
                const uploadArea = document.getElementById('upload-area');
                const fileInput = document.getElementById('file-input');
                uploadArea.addEventListener('click', () => fileInput.click());
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, e => {
                        e.preventDefault();
                        e.stopPropagation();
                    }, false);
                });
                uploadArea.addEventListener('dragenter', () => uploadArea.style.borderColor = 'var(--accent)');
                uploadArea.addEventListener('dragleave', () => uploadArea.style.borderColor = 'var(--border)');
                uploadArea.addEventListener('drop', (e) => {
                    uploadArea.style.borderColor = 'var(--border)';
                    this.handleFiles(e.dataTransfer.files);
                });
                fileInput.addEventListener('change', (e) => this.handleFiles(e.target.files));

                // --- Chatbot listeners ---
                const chatbotIcon = document.getElementById('chatbot-icon');
                const chatbotWindow = document.getElementById('chatbot-window');
                const chatbotClose = document.getElementById('chatbot-close');
                const chatbotSend = document.getElementById('chatbot-send');
                const chatbotInput = document.getElementById('chatbot-input');

                if (chatbotIcon && chatbotWindow && chatbotClose) {
                    chatbotIcon.addEventListener('click', () => chatbotWindow.classList.toggle('open'));
                    chatbotClose.addEventListener('click', () => chatbotWindow.classList.remove('open'));
                    chatbotSend.addEventListener('click', () => this.sendChatMessage());
                    chatbotInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.sendChatMessage();
                        }
                    });
                }
            }
            
            // --- UI Feedback ---
            showToast(message, isError = false) {
                const toast = document.getElementById('toast-notification');
                toast.textContent = message;
                toast.style.backgroundColor = isError ? '#e21d2f' : '#4CAF50'; // Red for error, Green for success
                 if(this.currentMode === 'calm') {
                    toast.style.backgroundColor = isError ? '#e21d2f' : '#7c3aed';
                }
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            // --- CORE LOGIC ---
            toggleMode() {
                this.currentMode = this.currentMode === 'impact' ? 'calm' : 'impact';
                localStorage.setItem('voiceguard-mode', this.currentMode);
                document.documentElement.setAttribute('data-mode', this.currentMode);
                this.updateModeToggle();
            }

            updateModeToggle() {
                document.getElementById('mode-text').textContent = this.currentMode === 'impact' ? 'Calm' : 'Impact';
            }

            setLanguage(lang) {
                this.currentLang = lang;
                localStorage.setItem('voiceguard-lang', lang);
                this.updateLanguage();
            }

            updateLanguage() {
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    const translation = this.i18n[this.currentLang]?.[key] || this.i18n.en[key];
                    el.textContent = translation;
                });
                
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-i18n-placeholder');
                    const translation = this.i18n[this.currentLang]?.[key] || this.i18n.en[key];
                    el.setAttribute('placeholder', translation);
                });

                document.getElementById('language-select').value = this.currentLang;
            }

            quickExit() {
                document.body.innerHTML = '';
                window.location.replace('https://weather.com');
            }

            // --- FEATURE-SPECIFIC LOGIC ---

            async toggleRecording() {
                this.isRecording = !this.isRecording;
                const recordBtn = document.getElementById('record-btn');
                const statusDot = document.getElementById('status-dot');
                const statusText = document.getElementById('status-text');
                
                const endpoint = this.isRecording ? '/start_monitoring' : '/stop_monitoring';
                
                try {
                    const response = await fetch(endpoint, { method: 'POST' });
                    const data = await response.json();

                    if (response.ok) {
                        this.showToast(data.message);
                        if (this.isRecording) {
                            recordBtn.setAttribute('data-i18n', 'recorder_stop');
                            recordBtn.classList.add('btn-danger');
                            statusDot.classList.add('recording');
                            statusText.setAttribute('data-i18n', 'recorder_recording');
                        } else {
                            recordBtn.setAttribute('data-i18n', 'recorder_start');
                            recordBtn.classList.remove('btn-danger');
                            statusDot.classList.remove('recording');
                            statusText.setAttribute('data-i18n', 'recorder_idle');
                        }
                    } else {
                        this.showToast(data.message, true);
                        this.isRecording = !this.isRecording; // Revert state on failure
                    }
                } catch (error) {
                    this.showToast('Network error. Could not connect to the server.', true);
                    this.isRecording = !this.isRecording; // Revert state on failure
                }
                this.updateLanguage();
            }

            async sendSOS() {
                const contactInput = document.getElementById('contact-input');
                const newContact = contactInput.value.trim();
                
                if (!newContact || !/^\+?\d{10,15}$/.test(newContact)) {
                    this.showToast('Please enter a valid phone number, including country code.', true);
                    return;
                }

                try {
                    const response = await fetch('/send_sms', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ phone: newContact })
                    });
                    const data = await response.json();

                    if (response.ok) {
                        this.showToast(data.message);
                        this.trustedContacts.push(newContact);
                        this.renderContacts();
                        contactInput.value = '';
                    } else {
                        this.showToast(data.message, true);
                    }
                } catch (error) {
                    this.showToast('Network error. Could not send SOS.', true);
                }
            }
            
            renderContacts() {
                const contactList = document.getElementById('contact-list');
                contactList.innerHTML = '';
                this.trustedContacts.forEach((contact, index) => {
                    const li = document.createElement('li');
                    li.className = 'contact-item';
                    li.innerHTML = `<span>${contact} (Alerted)</span>`;
                    contactList.appendChild(li);
                });
            }

            async handleFiles(files) {
                if (files.length === 0) return;

                const formData = new FormData();
                for (const file of files) {
                    this.uploadedFiles.push(file); // Add to local list for display
                    formData.append('files[]', file);
                }
                this.renderFiles(); // Update UI immediately

                try {
                    const response = await fetch('/upload_evidence', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.showToast(data.message);
                    } else {
                        this.showToast(data.message, true);
                    }
                } catch (error) {
                    this.showToast('Network error. Could not upload files.', true);
                }
            }

            renderFiles() {
                const fileList = document.getElementById('file-list');
                fileList.innerHTML = '';
                this.uploadedFiles.forEach((file, index) => {
                    const li = document.createElement('li');
                    li.className = 'file-item';
                    li.innerHTML = `<span>${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>`;
                    fileList.appendChild(li);
                });
            }

            // --- Chatbot Functionality ---
            getChatbotUserId() {
                let userId = localStorage.getItem('voiceguard-chatbot-userid');
                if (!userId) {
                    userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('voiceguard-chatbot-userid', userId);
                }
                return userId;
            }

            markdownToHtml(text) {
                // Convert **bold** to <strong>
                let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                // Convert newlines to <br>
                html = html.replace(/\n/g, '<br>');
                return html;
            }

            addChatMessage(message, sender) {
                const chatBody = document.getElementById('chatbot-body');
                const messageDiv = document.createElement('div');
                messageDiv.className = `chatbot-message ${sender}`;
                messageDiv.innerHTML = this.markdownToHtml(message);
                chatBody.appendChild(messageDiv);
                chatBody.scrollTop = chatBody.scrollHeight;
            }

            saveMessageToHistory(message, sender) {
                let history = JSON.parse(sessionStorage.getItem('voiceguard-chat-history')) || [];
                history.push({ message, sender });
                sessionStorage.setItem('voiceguard-chat-history', JSON.stringify(history));
            }

            loadChatHistory() {
                const history = JSON.parse(sessionStorage.getItem('voiceguard-chat-history'));
                if (history && history.length > 0) {
                    const chatBody = document.getElementById('chatbot-body');
                    // Clear the initial greeting message
                    chatBody.innerHTML = '';
                    history.forEach(item => {
                        this.addChatMessage(item.message, item.sender);
                    });
                }
            }

            async sendChatMessage() {
                const input = document.getElementById('chatbot-input');
                const message = input.value.trim();

                if (!message) return;

                this.addChatMessage(message, 'user');
                this.saveMessageToHistory(message, 'user');
                input.value = '';
                input.disabled = true;

                try {
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: this.chatbotUserId,
                            message: message,
                            language: this.currentLang,
                        }),
                    });

                    const data = await response.json();

                    if (data.response) {
                        this.addChatMessage(data.response, 'bot');
                        this.saveMessageToHistory(data.response, 'bot');
                    } else {
                        const errorMessage = 'Sorry, something went wrong.';
                        this.addChatMessage(errorMessage, 'bot');
                        this.saveMessageToHistory(errorMessage, 'bot');
                    }
                } catch (error) {
                    console.error('Chatbot error:', error);
                    const errorMessage = 'Sorry, I cannot connect to the server right now.';
                    this.addChatMessage(errorMessage, 'bot');
                    this.saveMessageToHistory(errorMessage, 'bot');
                } finally {
                    input.disabled = false;
                    input.focus();
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.voiceGuardDemo = new VoiceGuardDemoApp();
        });
    </script>
</body>
</html>
